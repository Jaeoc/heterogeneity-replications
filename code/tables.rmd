---
title: "Tables"
author: "Anton Ohlsson Collentine"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r load data and packages}
library(readr)
library(dplyr)
library(kableExtra)
library(purrr)
library(metafor)

dat <- read_csv("../data/collated_summary_data.csv")
```

##Summary table
```{r data-summary-table}
#library(dplyr)
#library(kableExtra)

summary.table <- dat %>% 
  group_by(rs) %>% 
  summarize(Labs = n_distinct(Site),
            Countries = n_distinct(country), 
            Effects = n_distinct(effect),
            Participants = if(Effects == 1){sum(Ntotal)}
                           else{sum(Ntotal) / Effects}) %>% #average across effects
  rename(Study = rs)

summary.table %>% knitr::kable("latex", booktabs = T, digits = 0) %>% 
  kable_styling(position = "left") %>% 
  footnote(threeparttable = TRUE,
           general = "For studies with several effects the number of participants is the average across effects, rounded to the closest whole number. Participant numbers are those used for primary analyses by original authors (i.e., after exclusions).")
```

```{r prep-heterogeneity-table}
#library(metafor)
#library(dplyr)
#library(purrr)

est_heterogen_smd_raw <- function(x){
  if(any(x[, "effect_type"] == "Risk difference")){ #without the 'any' we will get warnings because we apply 'if' to a vector
    
    fit <- rma(measure = "RD", ai = outcome_t1, bi = outcome_t2, ci = outcome_c1, di = outcome_c2,  n1i = ntreatment, n2i = ncontrol, test = "knha", data = x)
    
  } else if(any(x[, "outcomes1_2"] == "mean _ SE")){  
    
    fit <-  rma(yi = effect_size, sei = outcome_c2, test = "knha",  data = x) 
  
  } else if(any(x[, "effect_type"] == "Raw mean difference")){  
    
    fit <- rma(measure = "MD", m1i = outcome_t1, m2i = outcome_c1, sd1i = outcome_t2, sd2i = outcome_c2, n1i = ntreatment, n2i = ncontrol,test = "knha", data = x) 
  
  } else if(any(x[, "outcomes1_2"] == "mean _ SD")){  
    
    fit <- rma(measure = "SMD", m1i = outcome_t1, m2i = outcome_c1, sd1i = outcome_t2, sd2i = outcome_c2, n1i = ntreatment, n2i = ncontrol,test = "knha", data = x) 
       
  } else if(any(x[, "effect_type"] == "r")){
    
    fit <- rma(measure = "COR", ri = effect_size, ni = Ntotal, test = "knha", data = x)

  } else{ #for all two-group count effects
    
    fit <- rma(measure = "OR2DL", ai = outcome_t1, bi = outcome_t2, ci = outcome_c1, di = outcome_c2, #standardized, ML1 used 'OR2D' but that = 'OR2DL'
               n1i = ntreatment, n2i = ncontrol, test = "knha", data = x)
    
  }
  
  I2_1 <- confint(fit)$random[3, ] #Gives us the I2 estimate and its confidence interval
  data.frame(eff_size = fit$b[[1]], #effect size (point estimate)
             p = fit$pval,
             s_I2 = I2_1[1], s_ci.lb = I2_1[2], s_ci.ub = I2_1[3]) #I2 + CI
}

#Apply function to data
res <- dat %>% 
  split(.$effect) %>%  #separate by effect, necessary step otherwise the function is applied overall
  map_dfr(est_heterogen_smd_raw, .id = "effect") #apply function, rbind results into dataframe ('dfr'), make sure purrr is up to date

OR <- c("Allowed vs. forbidden", "Gain vs. loss framing", "Norm of reciprocity", "Low vs. high category scales") #Effects reported as d in many labs 1 but meta-analyzed as OR

#Add rs to the data-frame
het <- dat %>% 
  select(rs, effect, effect_type) %>% 
  group_by(rs, effect) %>% 
  summarize(effect_type = unique(effect_type)) %>% 
  left_join(res) %>% 
  mutate(effect_type = recode(effect_type, 
                              d = "Std. mean diff.",
                              r = "Correlation",
                              'Raw mean difference' = "Raw mean diff.")) %>% 
  arrange(desc(s_I2)) #sort by I2 for standardized effect
```

##Heterogeneity in preregistered multi-lab psychology studies
```{r heterogeneity-table}
library(kableExtra)
het %>% knitr::kable("latex", booktabs = T, digits = 2, col.names = c("RS", "Effect", "Effect type", "Estimate", "p-value", "I2(%)", "ci.lb", "ci.ub")) %>% 
  kable_styling() %>%
  footnote(threeparttable = TRUE,
           general = "We meta-analyzed effects using the same outcome measures that were used by the original authors. Standardized mean difference is Hedge's g. The following effects are odds ratios transformed into standardized mean differences: 'Allowed vs. forbidden', 'Gain vs. loss framing', 'Norm of reciprocity', 'Low vs. high category scales'. Effects were estimated in metafor using REML with the 'knha' correction. Estimate column are point estimates of effect sizes. Final columns are the upper and lower boundaries of the 90% confidence interval for I2.") 
  
```


