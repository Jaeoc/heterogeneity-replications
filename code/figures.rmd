---
title: "Figures"
author: "Heterogeneity in direct replications in psychology and its association with effect size"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.width = 6, fig.asp = 1.3)
```

```{r load packages, data and source helper functions}
if(!require(readr)){install.packages("readr")}
if(!require(metafor)){install.packages("metafor")}
if(!require(dplyr)){install.packages("dplyr")}
if(!require(purrr)){install.packages("purrr")}
if(!require(ggplot2)){install.packages("ggplot2")}
if(!require(cowplot)){install.packages("cowplot")}
if(!require(boot)){install.packages("boot")}

library(readr) #To load data
library(dplyr) #For data transformation
library(purrr) #For data iteration
library(metafor) #To run meta-analyses
library(ggplot2) #Plot data
library(cowplot) #Combine several plots into one
library(boot) #Bootstrap confidence intervals for correlations

dat <- read_csv("../data/collated_summary_data.csv")

source("helper_functions_tables_figures.r") #Load functions to prep data for figures
```

##Figure 1
```{r Plot_tau_against_I2, fig.asp = 0.618, cache = TRUE}
dat3 <- readRDS("../data/tau_simulation_results.RDS")
names(dat3) <- sort(unique(dat$effect)) #names were alphabetized upon splitting in simulation so must sort

OR2d <- c('Allowed vs. forbidden', 'Gain vs. loss framing', 'Norm of reciprocity', 'Low vs. high category scales') #effects that were transformed from OR to SMD

#Categorize effects by type of simulation for graphing
effect_type <- distinct(select(dat, effect, effect_type)) %>% 
  mutate(effect_type = ifelse(effect %in% OR2d | effect_type == "Risk difference" | 
                                effect_type == "Raw mean difference", "MD", effect_type),
         effect_type = recode(effect_type, "d" = 'SMD',
                              "r" = "Fisher's z"))



dat3 <- dat3 %>% 
  bind_rows(.id = "effect") %>% #create dataframe with identifier
  left_join(., effect_type) %>% 
  select(I2, tau, effect, effect_type) %>% 
  group_by(tau, effect, effect_type) %>% 
  summarize(I2 = mean(I2)) %>% #Take mean of I2 at each tau-level and for each effect
  ungroup()

#combined line plot gives good overview.
ggplot(dat3, aes(x = tau, y = I2, group = effect, color = effect_type)) +
  geom_line(alpha = 0.6) +
  theme_bw() +
  scale_x_continuous(name = expression(paste("Between studies standard deviation ", tau)),
                     minor_breaks = NULL) +
  scale_y_continuous(name = expression(paste(I^2," index", sep = "")),
                     minor_breaks = NULL) +
  coord_cartesian(ylim = c(0, 100)) +
  scale_color_brewer(name = "Effect type", palette = "Dark2", 
                     breaks = c("Fisher's z", "MD", "SMD")) +
  theme(legend.position = c(0.8, 0.4),
        legend.background = element_rect(linetype = "solid", color = "black")) +
  guides(color = guide_legend(override.aes = list(size = 1.4)))
  

# ggsave("../figures/tau-I2.png", dpi = 600, height =  4 , width = 6.47)

```
Figure 1. Result of simulation relating $I^2$-values to between studies standard deviation. Each line represent one of 37 effects. Tau is not directly comparable across effect size measures. 

##Figure 2
```{r Density_plot, cache = TRUE}

#1) I2 plot----
dens <- readRDS("../data/power_simulation_results.RDS")
names(dens) <-  sort(unique(dat$effect))

#Simulated data at various heterogeneity levels, prep for plotting
I2_dist <- dens %>% 
  bind_rows(.id = "effect") %>% 
  rename(Heterogeneity = tau_index) %>% 
  mutate(Heterogeneity = recode(Heterogeneity,
                            '1' = "Zero",
                            '2' = "Small",
                            '3' = "Medium",
                            '4' = "Large"),
         Heterogeneity = as.factor(Heterogeneity))

#Observed I2 estimates, i.e, results from main table, see table.rmd
#Effects estimated with sourced function 'est_heterogeen_smd_raw'
observed <- dat %>% 
  split(.$effect) %>%  
  map_dfr(est_heterogen_smd_raw, .id = "effect") %>% 
  select(effect, I2 = s_I2) %>%
  mutate(Heterogeneity = "Observed")

I2_plot <- ggplot(I2_dist, aes(x = I2, group = Heterogeneity, fill = Heterogeneity, linetype = Heterogeneity)) +
  geom_histogram(data = observed, aes(y = ..density.., x = I2), bins = 100, alpha = 1) +
  geom_density(alpha = 0.3) +
  theme_classic() +
  coord_cartesian(xlim = c(0, 100))  +
  scale_fill_brewer(palette = "Dark2",
                    breaks = c("Zero", "Small", "Medium", "Large", "Observed"),
                    labels = c("Zero (0%)", "Small (25%)", "Medium (50%)", "Large (75%)", "Observed")) +
  scale_linetype_manual(values = c( "dotdash", "dotted", "solid", "solid", "dashed"),
                        breaks = c("Zero", "Small", "Medium", "Large", "Observed"), 
                        labels = c("Zero (0%)", "Small (25%)", "Medium (50%)", "Large (75%)", "Observed")) +
  scale_color_brewer(palette = "Dark2", 
                     breaks = c("Zero", "Small", "Medium", "Large", "Observed"),
                     labels = c("Zero (0%)", "Small (25%)", "Medium (50%)", "Large (75%)", "Observed")) +
  theme(legend.position = c(0.85, 0.71),
        legend.background = element_rect(linetype = "solid", color = "black")) +
  scale_y_continuous(name = "Density") +
  scale_x_continuous(name = expression(paste(I^2," index", sep = ""))) +
  guides(fill = guide_legend(override.aes = list(alpha = c(rep(0.3, 4), 1))))

#ggsave("../figures/density-I2.pdf", dpi = 600, height =  4, width = 6.47, device = cairo_pdf())

#2) tau2 plot----

dens_tau2 <- readRDS("../data/biserial_simulation_results.RDS")
names(dens_tau2) <-  sort(unique(dat$effect))

# Simulated data at various heterogeneity levels, prep for plotting
tau2_dist <- dens_tau2 %>%
 bind_rows(.id = "effect") %>%
 rename(Heterogeneity = tau_index) %>%
 mutate(Heterogeneity = recode(Heterogeneity,
                             '1' = "Zero",
                             '2' = "Small",
                             '3' = "Medium",
                             '4' = "Large"),
          Heterogeneity = as.factor(Heterogeneity),
        tau = sqrt(tau2_hat))

# Observed tau2 estimates, i.e, results from main table, see table.rmd
# Effects transformed and estimated with sourced functions 'transform_MA' and 'summarizer'
observed_tau <- dat %>%
   split(.$effect) %>%
   map(transform_MA) %>% 
   map_dfr(summarizer, .id = "effect") %>%
   select(effect, tau2) %>%
   mutate(Heterogeneity = "Observed",
          tau = sqrt(tau2))

tau_plot <- ggplot(tau2_dist, aes(x = tau, group = Heterogeneity, fill = Heterogeneity, linetype = Heterogeneity)) +
  geom_histogram(data = observed_tau, aes(y = ..density.., x = tau), bins = 130, alpha = 1) +
  geom_density(alpha = 0.3) +
  theme_classic() +
  coord_cartesian(xlim = c(0, 0.25)) + #truncate plot for better visualization
  scale_fill_brewer(palette = "Dark2",
                     breaks = c("Zero", "Small", "Medium", "Large", "Observed"),
                     labels = c("Zero (0)", "Small (1/321)", "Medium (1/107)", "Large (3/107)", "Observed")) +
  scale_linetype_manual(values = c( "dotdash", "dotted", "solid", "solid", "dashed"),
                         breaks = c("Zero", "Small", "Medium", "Large", "Observed"),
                         labels = c("Zero (0)", "Small (1/321)", "Medium (1/107)", "Large (3/107)", "Observed")) +
  scale_color_brewer(palette = "Dark2",
                      breaks = c("Zero", "Small", "Medium", "Large", "Observed"),
                      labels = c("Zero (0)", "Small (1/321)", "Medium (1/107)", "Large (3/107)", "Observed")) +
  theme(legend.position = c(0.85, 0.71),
       legend.background = element_rect(linetype = "solid", color = "black")) +
  scale_y_continuous(name = "Density") +
  scale_x_continuous(name = expression(paste(italic(tau)," estimate", sep = ""))) +
  guides(fill = guide_legend(override.aes = list(alpha = c(rep(0.3, 4), 1))))

#ggsave("../figures/density-tau2.pdf", dpi = 600, height =  4, width = 6.47, device = cairo_pdf())

#3) combine I2-tau2-density-plots----
densities <- plot_grid(I2_plot, tau_plot, nrow = 2, labels = c("a", "b"), align = "v") #combine plots
densities

# save_plot("../figures/densities_het.png", densities,
#            nrow = 2,  base_width = 7, base_aspect_ratio = 0.618, dpi = 600)
```
Figure 2. Simulated $I^2$ (a) and $/tau^2$ (b) densities across 37 effects for zero, small, medium, and large heterogeneity according to the definitions of Higgins (2003), and a histogram of the observed I2 estimates for the 37 effects. For panel b) effects consist of correlations and biserial correlation and heterogeneity levels were approximated by Fisher’s z values corresponding to Higgins’ definitions for the median sample size of 108. Each simulated density consists of approximately 370,000 estimates. 

```{r transform_effect_and_compute_rma}
#Transform effect sizes to biserial correlations (pearson's correlations as is)
#then compute random effects meta-analyses per effect
#'transform_MA' and 'summarizer' are sourced functions
res <- dat %>% 
  split(.$effect) %>%  #necessary step otherwise the function is applied overall
  map(transform_MA) %>% #apply function each effect in the list
  map_dfr(summarizer, .id = "effect") %>%  #apply function and transform to dataframe
  mutate(r = abs(r)) #Absolute values since we are interested in effect size rather than direction
```



```{r cor_het_effect_size, results = "hide", cache=TRUE}
#Basic correlations
cor.test(res2$I2, res2$r) #pearson I2

I2_fit <- summary(lm(I2 ~ r, data = res2)) #for annotating figures

cor.test(res2$tau2, res2$r) #pearson tau2

tau2_fit <- summary(lm(tau2 ~ r, data = res2))

cor.test(res2$H2, res2$r) #pearson H2

H2_fit <- summary(lm(H2 ~ r, data = res2))

cor.test(res2$I2, res2$r, method = "spearman") #spearman

##Excluding anchoring effects
dropped_anchoring <- res2 %>%
  filter(!grepl("Anchoring", effect))

cor.test(dropped_anchoring$I2, dropped_anchoring$r) #pearson

#bootstrap confidence intervals
#code by Amir Abdol

#I2
pear <- function(formula, data, indices){ #pearson
     d <- data[indices,]
     fit <- cor.test(formula = ~ I2 + r, data=d)
     return(fit$estimate)
}

bootfit <- boot(data=res2, statistic=pear, R=1000, formula= ~ r + I2)

I2_ci_pears <- boot.ci(bootfit, type=c("perc", "bca")) #percentile and adjusted percental method (BCa)

spear <- function(formula, data, indices){ #spearman
     d <- data[indices,]
     fit <- cor.test(formula = ~ I2 + r, data=d, method = "spearman")
     return(fit$estimate)
}

options(warn=-1)
bootfit <- boot(data=res2, statistic=spear, R=1000, formula= ~ r + I2)
options(warn=0)

I2_ci_spear <- boot.ci(bootfit, type=c("perc", "bca"))

#Excluding anchoring effects
bootfit <- boot(data=dropped_anchoring, statistic=pear, R=1000, formula= ~ r + I2)

I2_dropped_ci_pears <- boot.ci(bootfit, type=c("perc", "bca")) #percentile and adjusted percental method (BCa)


#H2
pear <- function(formula, data, indices){
     d <- data[indices,]
     fit <- cor.test(formula = ~ H2 + r, data=d)
     return(fit$estimate)
}

bootfit <- boot(data=res2, statistic=pear, R=1000, formula= ~ r + H2)

H2_ci_pears <- boot.ci(bootfit, type=c("perc", "bca"))


```

##Figure 3
```{r plot_res, cache = TRUE}

#Plots of H2 and I2 vs. biserial correlation r for all effects together, two above chunks need to be run first

I2 <- ggplot(res2, aes(x = r, y = I2)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = TRUE, color = "black") +
  coord_cartesian(ylim = c(0, 100)) +
  annotate("text", x = 0.14, y = Inf, vjust = 5, fontface = "italic", size = 3.5, label = paste0("b = ", format(round(I2_fit$coefficients[2, 1], 2), nsmall = 2), ", r = ", format(round(sqrt(I2_fit$r.squared), 2), nsmall = 2))) +
  theme_classic() +
  theme(axis.text.x = element_blank(), #drop x-axis labels in preparation for combining plots
        axis.ticks.x = element_blank(),
        panel.border = element_rect(fill = NA, colour = "black", #add box around plots
                                    size = 0.5, linetype = "solid")) +
  scale_y_continuous(name = expression(paste(italic(I)^2," index"))) +
  scale_x_continuous(name = NULL)

H2 <- ggplot(res2, aes(x = r, y = H2)) + 
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = TRUE, color = "black") +
  annotate("text", x = 0.14, y = Inf, vjust = 5, size = 3.5, fontface = "italic", label = paste("b = ", format(round(H2_fit$coefficients[2, 1], 2), nsmall = 2), ", r = ", format(round(sqrt(H2_fit$r.squared), 2), nsmall = 2))) +
  theme_classic() +
  theme(axis.text.x = element_blank(), #drop x-axis labels in preparation for combining plots
        axis.ticks.x = element_blank(),
        panel.border = element_rect(fill = NA, colour = "black", #add box around plots
                                    size = 0.5, linetype = "solid")) +
  scale_y_continuous(name = expression(paste(italic(H)^2," index", sep = ""))) +
  scale_x_continuous(name = NULL)

tau2 <- ggplot(res2, aes(x = r, y = tau2)) + 
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = TRUE, color = "black") +
  annotate("text", x = 0.14, y = Inf, vjust = 5, size = 3.5, fontface = "italic", label = paste("b = ", format(round(tau2_fit$coefficients[2, 1], 2), nsmall = 2), ", r = ", format(round(sqrt(tau2_fit$r.squared), 2), nsmall = 2))) +
  theme_classic() +
  theme(panel.border = element_rect(fill = NA, colour = "black", #add box around plots
                                    size = 0.5, linetype = "solid")) +
  scale_y_continuous(name = expression(paste(italic(tau)^2, " estimate"))) +
  scale_x_continuous(name = expression(paste("Biserial and Pearson's correlations ")))

effect_het <- plot_grid(I2, H2, tau2, ncol = 1, align = "v", rel_heights = c(0.86, 0.86, 1), labels = c("a", "b", "c")) #combine plots
effect_het
# save_plot("../figures/effect-het.png", effect_het,
         # ncol = 1, base_height = 7, base_width = 5, dpi = 600)


```
Figure 3. The correlation between a) I2 ,and effect size and b) H2 and c)  τ ̂^2and effect size for 37 effects from ten pre-registered multi-lab replication projects. Shaded bands represent 95% confidence intervals

##Correlations per effect type (alternative figure 3, probably drop)
```{r corr_per_effect_type, cache = TRUE}
#Each set of input datapoints is meta-analyzed as per the original replication project
#Then correlated with tau2 per effect type
#Function 'est_heterogen_smd_raw' is sourced, see also tables.rmd
tau2_per_type <- dat %>% 
  split(.$effect) %>%  
  map_dfr(est_heterogen_smd_raw, .id = "effect")

#effects that were transformed from OR to SMD
OR2d <- c('Allowed vs. forbidden', 'Gain vs. loss framing', #originally transformed to SMD
           'Norm of reciprocity', 'Low vs. high category scales') #refit as OR

OR_fit <- function(x){ #fit rma to odds raios
  fit <- rma(measure = "OR", ai = outcome_t1, bi = outcome_t2, ci = outcome_c1, di = outcome_c2, n1i = ntreatment, n2i = ncontrol,  data = x)
  hetero <- confint(fit)$random[c(1, 3), ] 
  data.frame(eff_size = fit$b[[1]], #effect size (point estimate) 
             s_I2 = hetero[2, 1], s_ci.lb = hetero[2, 2], s_ci.ub = hetero[2, 3],
             tau2 = hetero[1, 1], tau2_ci.lb = hetero[1, 2], tau2_ci.ub = hetero[1, 3])}

fit_OR <- dat %>% 
  filter(effect %in% OR2d) %>% 
  split(.$effect) %>% 
  map_dfr(OR_fit, .id = "effect")


tau2_per_type <- dat %>% #This is to add the effect_type names
  select(effect, effect_type) %>% 
  distinct() %>% 
  mutate(effect_type = recode(effect_type, 
                              d = "Standardized Mean Difference",
                              'Raw mean difference' = "Mean Difference",
                              'Risk difference' = "Risk Difference",
                              'r' = "Correlation")) %>% 
  left_join(tau2_per_type) %>% 
  filter(!effect %in% OR2d) %>% #drop old SMD converted OR
  bind_rows(fit_OR) %>% #and instead add OR meta-analyzed as OR
  mutate(effect_type = ifelse(is.na(effect_type), "Odds Ratio", effect_type),
         eff_size = abs(eff_size)) #need the absolute values for plotting


fitter <- function(df){ #function to fit correlations for annotating facet plots
 fit <- summary(lm(tau2 ~ eff_size, data = df))
 data.frame(b = format(round(fit$coefficients[2, 1], digits = 2), nsmall = 2), #because map_dfr requires dataframe
            r = format(round(sqrt(fit$r.squared), digits = 2), nsmall = 2)) #output, the output is kept as two vars
}

labels <- tau2_per_type %>% 
  split(.$effect_type) %>% 
  map_dfr(fitter, .id = "effect_type") %>% 
  mutate(lab = paste0("b = ", b, ", r = ", r)) #put output into one variable for improved plotting
  

    
tau2_facet <- ggplot(tau2_per_type, aes(x = eff_size, y = tau2)) + 
  geom_point(alpha = 0.5) +
  geom_line(stat = "smooth", method = "lm", se = FALSE, color = "black", alpha = .5, linetype = "dashed") + #to set alpha for the line geom_line must be used rather than geom_smooth
  geom_text(data = labels, aes(label = lab), x = -Inf, y = Inf, hjust = -0.1, vjust = 6, size = 3.5, fontface = "italic") + #hjust and vjust can be used to annotate the same position in all facets
  scale_y_continuous(name = expression(paste("Between studies variance ", italic(tau)^2))) +
  scale_x_continuous(name = "Effect size") +
  theme_classic() +
  theme(strip.background = element_blank(), #remove box around titles
        strip.text = element_text(size = 12),
        panel.border = element_rect(fill = NA, colour = "black", #add box around plots
                                    size = 0.5, linetype = "solid")) + 
  facet_wrap(~effect_type, scales = "free") #use free scales since scales are different

tau2_facet
# ggsave("../figures/tau2_facet.png", dpi = 600, height =  7, width = 7)

```


