---
title: "Troubleshooting tau2"
author: "Anton Olsson Collentine"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r load packages, data and source functions}
if(!require(readr)){install.packages("readr")}
if(!require(metafor)){install.packages("metafor")}
if(!require(dplyr)){install.packages("dplyr")}
if(!require(purrr)){install.packages("purrr")}
if(!require(kableExtra)){install.packages("kableExtra")}
if(!require(writexl)){install.packages("writexl")}

library(readr) #To load data
library(dplyr) #For data transformation
library(purrr) #For data iteration
library(metafor) #To run meta-analyses
library(kableExtra) #For creating good-looking pdf tables
library(ggplot2)
library(cowplot)
library(writexl)


dat <- read_csv("../data/collated_summary_data.csv")

source("helper_functions_tables_figures.r") #Load functions to prep data for figures
```




```{r, cache = TRUE}
res <- dat %>% 
  split(.$effect) %>%  #separate by effect, necessary step otherwise the function is applied overall
  map_dfr(est_heterogen_smd_raw, .id = "effect") #apply function, rbind results into dataframe ('dfr'), make sure purrr is up to date

het <- dat %>% 
  select(rp, Site, effect, effect_type) %>% 
  group_by(rp, effect) %>% 
  summarize(effect_type = unique(effect_type),
            k = n_distinct(Site)) %>% 
  left_join(res) %>% 
  mutate(effect_type = recode(effect_type, 
                              d = "SMD.",
                              'Raw mean difference' = "MD",
                              'Risk difference' = "RD")) %>% 
  ungroup()

a <- het %>% filter(rp == "ML1" & !effect %in% c('Allowed vs. forbidden', 'Gain vs. loss framing','Norm of reciprocity', 'Low vs. high category scales') & effect_type == "SMD.") 

a_plot <- ggplot(a, aes(x = s_I2, y = sqrt(tau2))) + geom_point() + ggtitle("ML1 SMD - untransformed effect sizes")

```


```{r prepping, cache = TRUE}

#Transform effect sizes to biserial correlations (pearson's correlations left as is)
#estimate tau2 for correlations
#'transform_MA' and 'summarizer' are sourced functions
res2 <- dat %>% 
  split(.$effect) %>%  #separate by effect, necessary step otherwise the function is applied overall
  map(transform_MA) %>% #
  map_dfr(summarizer, .id = "effect")



#Add rp and k to the data-frame 
het <- dat %>% 
  select(rp, Site, effect, effect_type) %>% 
  group_by(rp, effect) %>% 
  summarize(effect_type = unique(effect_type),
            k = n_distinct(Site)) %>% 
  left_join(res2) %>% 
  mutate(effect_type = recode(effect_type, 
                              d = "SMD.",
                              'Raw mean difference' = "MD",
                              'Risk difference' = "RD")) %>% 
  ungroup()

b <- het %>% filter(rp == "ML1" & !effect %in% c('Allowed vs. forbidden', 'Gain vs. loss framing','Norm of reciprocity', 'Low vs. high category scales') & effect_type == "SMD.") 

b_plot <- ggplot(b, aes(x = I2, y = sqrt(tau2))) + geom_point() + ggtitle("ML1 biserial r - transformed SMD effect sizes")



```

```{r untruncated-biserial, cache = TRUE}


res3 <- dat %>%
  filter(rp == "ML1" & !effect %in% c('Allowed vs. forbidden', 'Gain vs. loss framing','Norm of reciprocity', 'Low vs. high category scales') & outcomes1_2 == "mean _ SD") %>% 
  split(.$effect) %>% 
  map(~transform_SD(.$outcome_t1, .$outcome_c1, .$outcome_t2, .$outcome_c2, .$ntreatment, .$ncontrol)) %>% 
  map(~untruncated_d_to_r(.$d, .$n1, .$n2)) %>% 
  map_dfr(summarizer, .id = "effect")

c_plot <- b_plot + geom_point(data = res3, shape = 4, aes(x = I2, y = sqrt(tau2)))




```

Figure 1.
```{r}
cowplot::plot_grid(a_plot, c_plot, ncol = 1)
```

**The four effects at the end are Anchoring 1,2,3,4. X corresponds to untruncated and circles are truncated**

We see that the non-monotonicity after transformation is not explained by truncation. Rather (especially in view of the 4th to last effect which wasn't truncated) there seems like there might be a relation with effect size.

##Effect size?
```{r, cache = TRUE}

both <- dat %>%
  filter(effect %in% c("Quote Attribution", "Anchoring 1 - NYC")) %>% 
  split(.$effect) %>% 
  map(function(x){
    metafor::escalc(measure = "SMD", m1i = x$outcome_t1, m2i = x$outcome_c1, sd1i = x$outcome_t2, sd2i = x$outcome_c2, n1i = x$ntreatment, n2i = x$ncontrol, data = x)
    })

both_trunc <- both %>% 
  map(~transform_d_to_r(.$yi, .$ntreatment, .$ncontrol)) 

both_nontrunc <- both %>% 
  map(~untruncated_d_to_r(.$yi, .$ntreatment, .$ncontrol)) 

both_tau2_d <- lapply(both, function(x){
  d_DL <-  rma(yi = x$yi, vi = x$vi, data = x, method = "DL")$tau2
  d_REML <-  rma(yi = x$yi, vi = x$vi, data = x)$tau2
  data.frame(d_DL = rep(d_DL, 36), d_REML = rep(d_REML, 36))})

both_tau2_trunc <- lapply(both_trunc, function(x){
  trunc_DL = rma(yi = x$r, vi = x$vi, data = x, method = "DL")$tau2
  trunc_REML = rma(yi = x$r, vi = x$vi, data = x)$tau2
  data.frame(trunc_DL = rep(trunc_DL, 36), trunc_REML = rep(trunc_REML, 36))})

#For excel
out <- bind_cols(both[[1]][, c("yi", "vi")], both[[2]][, c("yi", "vi")],
          both_trunc[[1]][, c("r", "vi")], both_trunc[[2]][, c("r", "vi")],
          both_nontrunc[[1]][, c("r", "vi")], both_nontrunc[[2]][, c("r", "vi")],
          both[[1]][, c("ntreatment", "ncontrol")], both[[2]][,c("ntreatment", "ncontrol")],
          both_tau2_d[[1]], both_tau2_d[[2]],
          both_tau2_trunc[[1]], both_tau2_trunc[[2]]) %>% 
  mutate_at(vars(contains("vi")), sqrt) %>% 
  select(yi, vi, yi1, vi1, r, r1, everything(), -r2, -r3) %>% 
  rename("Anch_d" = yi, "Anch_d_SE" = vi, "Quote_d" = yi1, "Quote_d_SE" = vi1,
         "Anch_r" = r, "Anch_trunc_SE" = vi2, "Quote_r" = r1, "Quote_trunc_SE" = vi3,
         "Anch_nontrunc_SE" = vi4, "Quote_nontrunc_SE" = vi5,
         "Anch_n1" = ntreatment, "Anch_n2" = ncontrol, "Quote_n1" = ntreatment1, "Quote_n2" = ncontrol1,
         "Anch_d_tau2_DL" = d_DL, "Anch_d_tau2_REML" = d_REML, "Quote_d_tau2_DL" = d_DL1, "Quote_d_tau2_REML" = d_REML1,
         "Anch_trunc_tau2_DL" = trunc_DL, "Anch_trunc_tau2_REML" = trunc_REML, "Quote_trunc_tau2_DL" = trunc_DL1, "Quote_trunc_tau2_REML" = trunc_REML1)
  



# write_xlsx(out, "effect_sizes_with_SE.xlsx")
```

```{r}
eff <- out %>% 
  mutate(ratio_SE_d = Anch_d_SE / Quote_d_SE,
         ratio_SE_biserial = Anch_trunc_SE / Quote_trunc_SE,
         Quote_ratio = Quote_d_SE / Quote_trunc_SE,
         Anch_ratio = Anch_d_SE / Anch_trunc_SE,
         diff = ratio_SE_d - ratio_SE_biserial) %>%
  arrange(desc(Anch_d)) %>%
  select(Anch_d, Quote_d, Quote_ratio, Anch_ratio, ratio_SE_d, ratio_SE_biserial, diff)

```


- The transformation is not monotonic for large values and this is not explained by the truncation (see next section) which almost only affects the I2

- Let's take a closer look at two effects with very different effect sizes (mean SMD `r round(mean(eff$Quote_d), 2)` vs. `r round(mean(eff$Anch_d), 2)`): Quote attribution [fifth effect from the right Figure 1] vs. Anchoring 1. [4th effect from the right Figure 1].

**Facts so far:**

a) After transformation we see an unexpected pattern in heterogeneity estimates amongst the four largest effect sizes; tau2 seems too low compared to I2

b) The transformation affects sampling variance estimates differently depending on effect size; the relative decrease in sampling variance is larger the larger the effect size. In other words, after transformation the larger effect sizes have relatively more weight than before the transformation (see table below).

c) This is true both across effects and within effects. E.g., for the Anchoring effect size d = 1.94 the ratio of the  pre-transformation variance to post-transformation variance is 4.92 whereas for the effect size d = .78 it is 1.98. This correlation is almost perfect (_r_ = `r cor(eff$Anch_ratio, eff$Anch_d)`) 

d) For anchoring 1, 15/36 effect sizes are above the mean


```{r}

knitr::kable(eff, booktabs = TRUE) 
```
Note: Anch_d = SMD Anchoring, Quote_d = SMD Quote attribution, Quote_ratio = pre-transformation SE / post-transformation SE for Quote attribution, Anch_ratio = pre-transformation SE / post-transformation SE for Anchoring 1, ratio_SE_d = Ratio SMD SEs: Anchoring / Quote attribution, ratio_SE_biserial = Ratio biserial SEs: Anchoring / Quote attribution, diff = Ratio SMD - Ratio biserial.

```{r above_average_anchoring}
dat %>% filter(grepl("Anchoring", effect)) %>% 
  group_by(effect) %>% 
  summarize(above_average = sum(effect_size - mean(effect_size) > 0))
```

##Truncation problems?
**Compare the actual values**
```{r, cache = TRUE}
b %>% select(effect, r, tau2, I2) %>% left_join(res3 %>% select(effect, r, tau2, I2), by = "effect") %>% 
  rename(trunc_ES = r.x, trunc_tau = tau2.x, trunc_I2 = I2.x, nontrunc_ES  = r.y, nontrunc_tau = tau2.y, nontrunc_I2 = I2.y) %>% 
  mutate(trunc_tau = sqrt(trunc_tau), nontrunc_tau = sqrt(nontrunc_tau)) %>% 
  knitr::kable(booktabs = TRUE)


```

It is strange that there are (very slightly) different outcomes for non-truncated effects, this is probably due to metafor (which I use for truncation) uses the exact variance formula whereas I use the approximate. Compare truncated vs. non-truncated manual formulas to check:
```{r}
res4 <- dat %>%
  filter(rp == "ML1" & !effect %in% c('Allowed vs. forbidden', 'Gain vs. loss framing','Norm of reciprocity', 'Low vs. high category scales') & outcomes1_2 == "mean _ SD") %>% 
  split(.$effect) %>% 
  map(~transform_SD(.$outcome_t1, .$outcome_c1, .$outcome_t2, .$outcome_c2, .$ntreatment, .$ncontrol)) %>% 
  map(~transform_d_to_r(.$d, .$n1, .$n2)) %>% 
  map_dfr(summarizer, .id = "effect")

res4 %>% select(effect, r, tau2, I2) %>% left_join(res3 %>% select(effect, r, tau2, I2), by = "effect") %>% 
  rename(trunc_ES = r.x, trunc_tau = tau2.x, trunc_I2 = I2.x, nontrunc_ES  = r.y, nontrunc_tau = tau2.y, nontrunc_I2 = I2.y) %>% 
  mutate(trunc_tau = sqrt(trunc_tau), nontrunc_tau = sqrt(nontrunc_tau)) %>% 
  knitr::kable(booktabs = TRUE) 
```
Exactly the same result for non-truncated effects, so that seems to be the case

Let's take a closer look at the truncated vs. untruncated variance estimates for Anchoring 4 which has the largest change in I2.

```{r, cache = TRUE}
anch4 <- dat %>%
  filter(effect == "Anchoring 4 - Babies") %>% 
  rowwise() %>% 
  do(transform_SD(.$outcome_t1, .$outcome_c1, .$outcome_t2, .$outcome_c2, .$ntreatment, .$ncontrol)) 
#See this stackoverflow question to understand the usage of rowwise and 'do'
#https://stackoverflow.com/questions/22240816/dplyr-summarise-with-multiple-return-values-from-a-single-function

anch4_trunc <- anch4 %>% 
  do(transform_d_to_r(.$d, .$n1, .$n2))

anch4_nontrunc <- anch4 %>% 
  do(untruncated_d_to_r(.$d, .$n1, .$n2))

bind_cols(anch4_trunc, anch4_nontrunc) %>% 
  rename(trunc_vi = vi, nontrunc_vi = vi1) %>% 
  select(r, trunc_vi, nontrunc_vi, n) %>% 
  arrange(desc(r)) %>% 
  knitr::kable(booktabs = TRUE)


```
Note that the (biserial) r itself is not truncated and so the same between the two. It is clear truncation leads to a larger estimate of the variance for an effect. 

**To summarize: Truncation leads to an increase in estimated study variance, but a (small) decrease in meta-analytic effect size estimate. In other words, truncation (as seen in the first figure) leads to a lower I2 but does not affect the $\tau$ particularly**



##Old stuff

Check which effects get truncated:

```{r, echo = TRUE, cache = TRUE}
dat %>% 
  split(.$effect) %>% 
  map_dfr(transform_MA, .id = "effect") %>% 
  filter(r > 1)
```

Basically the anchoring effects.


```{r, }
het %>% filter(rp == "ML3") %>% ggplot(aes(x = I2, y = sqrt(tau2))) + geom_point() + facet_wrap(~effect_type) + ggtitle("ML3 (SMD transformed to biserial correlations)")
```

**The one non-increasing effect in the left plot above is 'Credentials interaction'. **
However, note that all the ML3 'correlations' are either transformed partial eta-squared of 2x2 tables in the first table (we can't fix this, would have to get into the raw data which seems liek too much work, I mentioned this in the revised draft)



```{r}
het %>% ggplot(aes(x = I2, y = sqrt(tau2))) + geom_point() + ggtitle("All effects - tetrachoric, biserial & product-moment r")
```
The effect that is close to one of the anchoring effects (I2 ~75, tau ~.05) is Allowed vs. forbidden which also has r = .90.


