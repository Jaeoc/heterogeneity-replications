---
title: "Supplement - Biserial correlation transformations"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
Sys.setlocale("LC_TIME", "English" ) #to print date in YAML in English
```

```{r load packages, data and source functions}
if(!require(readr)){install.packages("readr")}
if(!require(metafor)){install.packages("metafor")}
if(!require(dplyr)){install.packages("dplyr")}
if(!require(purrr)){install.packages("purrr")}
if(!require(kableExtra)){install.packages("kablExxtra")}

library(readr) #To load data
library(dplyr) #For data transformation
library(purrr) #For data iteration
library(metafor) #To run meta-analyses
library(ggplot2) #plotting figures
library(cowplot) #combine plots
library(kableExtra) #create fancy pdf tables

dat <- read_csv("../data/collated_summary_data.csv")

source("helper_functions_tables_figures.r") #Load functions to prep data for figures
```


```{r a-plot-prep, cache = TRUE}
res <- dat %>% 
  split(.$effect) %>%  #separate by effect, necessary step otherwise the function is applied overall
  map_dfr(est_heterogen_smd_raw, .id = "effect") #apply function, rbind results into dataframe ('dfr'), make sure purrr is up to date

het <- dat %>% 
  select(rp, Site, effect, effect_type) %>% 
  group_by(rp, effect) %>% 
  summarize(effect_type = unique(effect_type),
            k = n_distinct(Site)) %>% 
  left_join(res) %>% 
  mutate(effect_type = recode(effect_type, 
                              d = "SMD.",
                              'Raw mean difference' = "MD",
                              'Risk difference' = "RD")) %>% 
  ungroup()

a <- het %>% filter(rp == "ML1" & !effect %in% c('Allowed vs. forbidden', 'Gain vs. loss framing','Norm of reciprocity', 'Low vs. high category scales') & effect_type == "SMD.")
```


```{r, cache = FALSE}
a_plot <- ggplot(a, aes(x = s_I2, y = sqrt(tau2))) + geom_point() + ggtitle("SMD (untransformed)") +
  scale_x_continuous(name = expression(paste(italic(I)^2, "Index"))) +
  scale_y_continuous(name = "Tau")

```


```{r trunc-biserial, cache = TRUE}
#Transform effect sizes to biserial correlations (pearson's correlations left as is)
#estimate tau2 for correlations
#'transform_MA' and 'summarizer' are sourced functions
res2 <- dat %>% 
  split(.$effect) %>%  #separate by effect, necessary step otherwise the function is applied overall
  map(transform_MA) %>% #
  map_dfr(summarizer, .id = "effect")



#Add rp and k to the data-frame 
het <- dat %>% 
  select(rp, Site, effect, effect_type) %>% 
  group_by(rp, effect) %>% 
  summarize(effect_type = unique(effect_type),
            k = n_distinct(Site)) %>% 
  left_join(res2) %>% 
  mutate(effect_type = recode(effect_type, 
                              d = "SMD.",
                              'Raw mean difference' = "MD",
                              'Risk difference' = "RD")) %>% 
  ungroup()

d <- het %>% filter(rp == "ML1" & !effect %in% c('Allowed vs. forbidden', 'Gain vs. loss framing','Norm of reciprocity', 'Low vs. high category scales') & effect_type == "SMD.") %>% 
  mutate(sigma2 = tau2/(I2/100) - tau2) #add 'typical within study variance' per project 

```


```{r c-plot-1, cache = FALSE}
c_plot_1 <- ggplot(d, aes(x = I2, y = sqrt(tau2))) + geom_point() + ggtitle("Biserial r (transformed SMD)")



```

```{r untruncated-biserial, cache = TRUE}
res3 <- dat %>%
  filter(rp == "ML1" & !effect %in% c('Allowed vs. forbidden', 'Gain vs. loss framing','Norm of reciprocity', 'Low vs. high category scales') & outcomes1_2 == "mean _ SD") %>% 
  split(.$effect) %>% 
  map(~transform_SD(.$outcome_t1, .$outcome_c1, .$outcome_t2, .$outcome_c2, .$ntreatment, .$ncontrol)) %>% 
  map(~untruncated_d_to_r(.$d, .$n1, .$n2)) %>% 
  map_dfr(summarizer, .id = "effect")
```


```{r c-plot, cache = FALSE}
c_plot <- c_plot_1 + geom_point(data = res3, shape = 4, aes(x = I2, y = sqrt(tau2))) +
  scale_x_continuous(name = expression(paste(italic(I)^2, " Index (biserial)"))) +
  scale_y_continuous(name = "Tau (biserial)")




```

```{r tau-vs-tau}
b <- select(a, effect, tau2) %>% 
  left_join(select(d, effect, tau2), by = "effect") %>% #add truncated transformation tau2
  left_join(select(res3, effect, tau2), by = "effect") #add untruncated transformation tau2
```


```{r b-plot-1}
b_plot_1 <- ggplot(b, aes(x = sqrt(tau2.x), y = sqrt(tau2.y))) + 
  geom_point() 

```

```{r b-plot}
b_plot <- b_plot_1 + geom_point(data = b, shape = 4, aes(x = sqrt(tau2.x), y = sqrt(tau2))) +
  ggtitle("SMD vs. biserial") +
  scale_x_continuous(name = "Tau (SMD)") +
  scale_y_continuous(name = "Tau (biserial)")
```



```{r, fig.width = 6, fig.asp = 1.3}
cowplot::plot_grid(a_plot, b_plot, c_plot, ncol = 1, labels = "AUTO")


# ggsave("../figures/Figure-S1.png", dpi = 600, width = 6, height = 7.8)
```

_Figure S.1_ Association between estimates of $\tau$ and $I^2$ after and before standardized mean differences (SMD) effects were transformed into biserial correlations for all effects reported as SMDs in ManyLabs 1. Panel A shows the association between estimates of $\tau$ and $I^2$ without transformation when using the meta-analytic specification of the original authors (see main text). Panel B shows the association between estimates of $\tau$ for the same effects before and after transformation to biserial correlations, either with truncation of correlations over 1 (circles) or without (crosses) when estimating variance. Panel C  shows the associations between estimates of $I^2$ on the SMD metric and estimates of $\tau$ after transformation, either with truncation or not. 


#Table S1.
###Heterogeneity across primary effects and statistical power of ten multi-lab replication projects, ordered with respect to estimated heterogeneity ($I^2$).
```{r prep-heterogeneity-table, cache = TRUE}
#library(metafor)
#library(dplyr)
#library(purrr)

#fit a random effects model to all empirical data
#Each set of input datapoints is meta-analyzed as per the original replication project
#Function 'est_heterogen_smd_raw' is sourced
res <- dat %>% 
  split(.$effect) %>%  #separate by effect, necessary step otherwise the function is applied overall
  map_dfr(est_heterogen_smd_raw, .id = "effect") %>% #apply function, rbind results into dataframe ('dfr'), make sure purrr is up to date
  mutate(tau = sqrt(tau2),
         tau_ci.lb = sqrt(tau2_ci.lb),
         tau_ci.ub = sqrt(tau2_ci.ub)) %>% 
  select(-tau2, - tau2_ci.lb, -tau2_ci.ub) #drop redundant variables

#Transform effect sizes to biserial correlations (pearson's correlations left as is)
#estimate tau2 for correlations
#'transform_MA' and 'summarizer' are sourced functions
res2 <- dat %>% 
  split(.$effect) %>%  #separate by effect, necessary step otherwise the function is applied overall
  map(transform_MA) %>% #
  map_dfr(summarizer, .id = "effect")

res <- res %>%
  mutate(r = res2$r,
         tau_r = sqrt(res2$tau2), #For table 3, report tau and transformed effect sizes (biserial correlations)
         tau_r_ci.lb = sqrt(res2$tau2.lb),
         tau_r_ci.ub = sqrt(res2$tau2.ub))

#Add rp and k to the data-frame and prep for table
het <- dat %>% 
  select(rp, Site, effect, effect_type) %>% 
  group_by(rp, effect) %>% 
  summarize(effect_type = unique(effect_type),
            k = n_distinct(Site)) %>% 
  left_join(res) %>% 
  mutate(effect_type = recode(effect_type, 
                              d = "SMD",
                              'Raw mean difference' = "MD",
                              'Risk difference' = "RD")) %>% 
  ungroup()

#Load simulation results (power/type 1 error for all effects)
dens <- readRDS("../data/power_simulation_results.RDS")
names(dens) <-  sort(unique(dat$effect)) #names were alphabetized upon splitting in simulation so must sort

#Summary of simulation results, needs to be combined with main part of table
I2_power <- dens %>% 
  bind_rows(.id = "effect") %>% 
  group_by(effect, tau_index) %>% 
  summarize(power = mean(Qp <= 0.05)) %>% #Estimate power/type 1 error for each tau level and effect
  ungroup() %>% 
  tidyr::spread(key = tau_index, value = power) %>% #prep for table
  rename(zero = '1', small = '2', medium = '3', large = '4')

#Combine dataframes to create full table
het <-  het %>% 
  left_join(I2_power) %>% 
  arrange(desc(s_I2),  desc(s_ci.ub)) %>% #sort by I2 and upper CI bound
  mutate(I2_ci = paste0("[", trimws(format(round(s_ci.lb, 1), nsmall = 1)), ", ", trimws(format(round(s_ci.ub, 1), nsmall = 1)), "]"), #Round and put confidence interval between brackets, e.g., [0, 0.41]
         s_I2 = format(round(s_I2, 1), nsmall = 1),
         tau_ci = paste0("[", trimws(format(round(tau_ci.lb, 3), nsmall = 3)), ", ", trimws(format(round(tau_ci.ub, 3), nsmall = 3)), "]"),
         tau = format(round(tau, 3), nsmall = 3),
         tau_r = format(round(tau_r, 3), nsmall = 3),
         tau_r_ci = paste0("[", trimws(format(round(tau_r_ci.lb, 3), nsmall = 3)), ", ", trimws(format(round(tau_r_ci.ub, 3), nsmall = 3)), "]")) %>% #rounded here instead of in table function because should have 4 digits
  select(rp, effect, k, effect_type, eff_size, s_I2, I2_ci, tau, tau_ci, r, tau_r, tau_r_ci, zero, small, medium, large)

```


```{r heterogeneity-table, cache = FALSE}
#library(kableExtra)

het %>% knitr::kable(align = "c", booktabs = TRUE, escape = FALSE, digits = 2, col.names = c("RP", "Effect", "K", "Effect type", "Effect size estimate",  "$I^2$(\\%)", "$I^2$ 95\\% CI", "$\\tau$", "$\\tau$ 95\\% CI", "r*" , "r* $\\tau$", "r* $\\tau$ 95\\% CI", "Zero", "Small", "Medium", "Large")) %>% 
  add_header_above(c(" " = 12, "Level of heterogeneity" = 4)) %>% 
  add_header_above(c(" " = 12, "Type I Error Rate & Statistical Power" = 4)) %>% 
  kable_styling("scale_down", font_size = 7) %>% #comment out if outputting html file
  column_spec(5, width = "5em") %>% #make sure the 'Effect size estimate' header is wrapped 
  footnote(threeparttable = TRUE, escape = FALSE,
           general = "Effects were estimated in metafor using REML. The following effects are odds ratios transformed into standardized mean differences: 'Allowed vs. forbidden', 'Gain vs. loss framing', 'Norm of reciprocity', 'Low vs. high category scales'. RP = Replication Project, K = no. primary studies, CI = confidence intervals, r* = effect sizes as correlations and biserial correlations. $I^2$ and its confidence intervals are for original effect size specifications whereas $\tau$ and its confidence intervals are for transformed r* effect sizes. Statistical power and type I error rates were simulated, where Zero = simulated type 1 error, and the other headers represent simulated power under small/medium/large heterogeneity ($I^2$ = 25/50/75\\\\%) respectively. SMD = Standardized Mean difference (Hedge's g), MD = Mean Difference, RD = Risk Difference, r = correlation. Code to reproduce table: osf.io/kf6pt/",
           alphabet = "These effects were simulated as standardized mean differences") %>% 
  landscape()


```


